## Project description

An example of an ad-bot detector. User's click\view event stream is generated by a provided script.
Pipeline: `[Events file] -> [Kafka Connect] -> [Kafka] -> [Spark] -> [Cassandra]`
An events file is generated by a provided Python script.

### Prerequisites
This project uses and expects specified software to be installed on a runtime environment:
- Git
- JVM
- SBT
- Docker

## Project setup

```
git clone https://github.com/MaxNevermind/spark-streaming-example.git
cd spark-streaming-example\
sbt assembly
docker-compose up -d
```

Create a topic for incoming events

`docker exec broker kafka-topics --create --zookeeper zookeeper:2181 --replication-factor 1 --partitions 3 --topic incoming-events`

Create Cassandra key space and table

```
docker exec -it cassandra /bin/bash

cqlsh

CREATE KEYSPACE standalone
  WITH REPLICATION = { 
   'class' : 'SimpleStrategy', 
   'replication_factor' : 1 
  };
  
CREATE TABLE standalone.blocked_ips (
   ip text PRIMARY KEY, 
   request_count int, 
   click_view_ratio float, 
   categories_count int);
```

Add Kafka file source connector for incoming events

`curl --header "Content-Type: application/json" --request POST --data '{"name":"FileStreamSourceConnector","config":{"connector.class":"org.apache.kafka.connect.file.FileStreamSourceConnector","tasks.max":"1","topic":"incoming-events","key.converter":"org.apache.kafka.connect.storage.StringConverter","value.converter":"org.apache.kafka.connect.storage.StringConverter","file":"/usr/share/streaming_task/events/events.json"}}' \
http://localhost:8083/connectors`

Start events generator

`python3 ./src/main/python/botgen.py --file ./events/events.json --duration 5`

Start spark application

`docker exec -it spark /bin/bash`

`mkdir /tmp/spark-events`

`/usr/share/spark/bin/spark-submit \
--class StreamingApp \
--master local[2] \
/usr/share/streaming_task/target/scala-2.11/streaming_task-assembly-0.1.0-SNAPSHOT.jar`

Check the result in Cassandra

`docker exec -it cassandra /bin/bash`

`cqlsh`

`SELECT * FROM standalone.blocked_ips LIMIT 10;`   


## Utility commands

Get list of topics

`docker exec broker kafka-topics --list --zookeeper zookeeper:2181`

Get the first 10 messages from a topic

`docker exec broker kafka-console-consumer --bootstrap-server broker:9092 --topic incoming-events --from-beginning --max-messages 10`

Reset offset for spark consumer

`docker exec broker kafka-consumer-groups --bootstrap-server broker:9092 --group spark_consumer --topic incoming-events --reset-offsets --to-earliest --execute`

